<button id="playButton" onclick="togglePlay()">å†ç”Ÿ / åœæ­¢</button>

<h3>é«˜èª¿æ³¢æŒ¯å¹…ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« (1å€ ã€œ 10å€)</h3>
<div id="controls">
    </div>

<script>
    
const audioContext = new (window.AudioContext || window.webkitAudioContext)();

    // 2.ã®JavaScriptã‚³ãƒ¼ãƒ‰ã‚’ã“ã“ã«é…ç½®
// ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
const fundamentalFrequency = 440; // åŸºæœ¬å‘¨æ³¢æ•° (f0)
const harmonics = 10;             // åˆæˆã™ã‚‹é«˜èª¿æ³¢ã®æ•° (1å€ã‹ã‚‰10å€)

// é«˜èª¿æ³¢ã¨ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã‚’ä¿æŒã™ã‚‹é…åˆ—
const oscillators = [];
const gains = [];

// ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†
function createSynth() {
    // æ—¢å­˜ã®ãƒãƒ¼ãƒ‰ãŒã‚ã‚Œã°åœæ­¢ãƒ»è§£é™¤
    oscillators.forEach(osc => osc.stop());
    oscillators.length = 0;
    gains.length = 0;

    for (let k = 1; k <= harmonics; k++) {
        // 1. ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒãƒ¼ãƒ‰ (ã‚µã‚¤ãƒ³æ³¢)
        const osc = audioContext.createOscillator();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(fundamentalFrequency * k, audioContext.currentTime);

        // 2. ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ (æŒ¯å¹…åˆ¶å¾¡)
        const gainNode = audioContext.createGain();
        
        // æŒ¯å¹…ã‚’è¨­å®šï¼ˆä¾‹: ãƒã‚³ã‚®ãƒªæ³¢çš„ãªæ¸›è¡°ã€å…¨ä½“ã‚’0.1ã§ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã®å€¤ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ãŒã‚¢ãƒ—ãƒªã®æ ¸ã«ãªã‚Šã¾ã™
        const amplitude = (1 / k) * 0.1; 
        gainNode.gain.setValueAtTime(amplitude, audioContext.currentTime);

        // 3. æ¥ç¶š
        // ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ -> ã‚²ã‚¤ãƒ³ -> å‡ºåŠ›
        osc.connect(gainNode);
        gainNode.connect(audioContext.destination);

        // é…åˆ—ã«æ ¼ç´
        oscillators.push(osc);
        gains.push(gainNode);
    }
}

let isPlaying = false;

function togglePlay() {
    if (!isPlaying) {
        // æœ€åˆã«ãƒãƒ¼ãƒ‰ã‚’ä½œæˆ
        if (oscillators.length === 0) {
            createSynth();
        }
        
        // ã™ã¹ã¦ã®ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’åŒæ™‚ã«ã‚¹ã‚¿ãƒ¼ãƒˆ
        oscillators.forEach(osc => {
            // start() ã¯ä¸€åº¦ã—ã‹å‘¼ã¹ãªã„ã®ã§ã€åœæ­¢ã—ãŸå ´åˆã¯ãƒãƒ¼ãƒ‰ã‚’å†ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹
            try {
                osc.start();
            } catch (e) {
                // ã™ã§ã« start ã•ã‚Œã¦ã„ã‚‹å ´åˆã®å‡¦ç†ï¼ˆé€šå¸¸ã¯ stopå¾Œã«ãƒãƒ¼ãƒ‰ã‚’å†ä½œæˆï¼‰
                console.error("Oscillator already started. Recreating synth.");
                createSynth();
                oscillators.forEach(o => o.start());
                return;
            }
        });
        isPlaying = true;
        console.log("å†ç”Ÿé–‹å§‹");

    } else {
        // ã™ã¹ã¦ã®ã‚ªã‚·ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’åŒæ™‚ã«ã‚¹ãƒˆãƒƒãƒ—
        oscillators.forEach(osc => osc.stop(audioContext.currentTime + 0.05)); // ã‚ãšã‹ã«é…å»¶ã•ã›ã¦ã‚¯ãƒªãƒƒã‚¯éŸ³ã‚’é˜²æ­¢
        
        // ãƒãƒ¼ãƒ‰ã‚’åœæ­¢ã—ãŸã‚‰å†åˆ©ç”¨ã§ããªã„ãŸã‚ã€é…åˆ—ã‚’ã‚¯ãƒªã‚¢
        oscillators.length = 0; 
        gains.length = 0;
        
        isPlaying = false;
        console.log("å†ç”Ÿåœæ­¢");
    }
}

</script>

// ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ä½œæˆã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
function setupControls() {
    const controlsDiv = document.getElementById('controls');
    for (let k = 1; k <= harmonics; k++) {
        const label = document.createElement('label');
        label.textContent = `${k}å€ (æŒ¯å¹…): `;

        const slider = document.createElement('input');
        slider.type = 'range';
        slider.min = 0;
        slider.max = 1;
        slider.step = 0.01;
        
        // åˆæœŸå€¤ã®è¨ˆç®— (ä¾‹: 1/k)
        slider.value = (1 / k) * 0.5; // ã‚¹ã‚±ãƒ¼ãƒ«ã‚’è€ƒæ…®ã—ã¦èª¿æ•´

        slider.id = `slider-${k}`;
        
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’å¤‰æ›´ã—ãŸã‚‰ã€å¯¾å¿œã™ã‚‹ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã‚’æ›´æ–°ã™ã‚‹
        slider.oninput = (e) => {
            if (gains[k - 1]) { // kã¯1ã‹ã‚‰å§‹ã¾ã‚‹ãŸã‚ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ k-1
                // ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰ã®å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¤‰æ›´
                gains[k - 1].gain.setValueAtTime(e.target.value * 0.2, audioContext.currentTime); 
            }
        };

        controlsDiv.appendChild(label);
        controlsDiv.appendChild(slider);
        controlsDiv.appendChild(document.createElement('br'));
    }
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œ
document.addEventListener('DOMContentLoaded', () => {
    setupControls();
    // æœ€åˆã«ä¸€åº¦ã ã‘ createSynth ã‚’å‘¼ã³å‡ºã—ã¦ã€ãƒãƒ¼ãƒ‰ã®é…åˆ—ã‚’åˆæœŸåŒ–ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œã®ãŸã‚ï¼‰
    createSynth();
});

<h3>åˆæˆæ³¢å½¢</h3>
<canvas id="waveformCanvas" width="400" height="200" style="border: 1px solid #ccc;"></canvas> 

// ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°å‘¨æ³¢æ•° (æç”»ã®è§£åƒåº¦)
const DRAW_SAMPLE_RATE = 1024; 
// æç”»ã™ã‚‹åŸºæœ¬å‘¨æ³¢æ•° (f0)
const DRAW_FREQUENCY = 440; 
// æç”»ã™ã‚‹æ³¢å½¢ã®æ™‚é–“é•·ï¼ˆã“ã“ã§ã¯1å‘¨æœŸåˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã†ï¼‰
const DRAW_DURATION = 1 / DRAW_FREQUENCY; 
// æç”»ã™ã‚‹ã‚µãƒ³ãƒ—ãƒ«ã®ç·æ•°
const NUM_SAMPLES = Math.round(DRAW_SAMPLE_RATE * DRAW_DURATION); 

/**
 * ç¾åœ¨ã®ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼è¨­å®šã«åŸºã¥ã„ã¦ã€æ³¢å½¢ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹
 * @returns {number[]} æ³¢å½¢ãƒ‡ãƒ¼ã‚¿ã®é…åˆ—
 */
function generateWaveformData() {
    const data = [];
    
    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤ã‚’å–å¾— (ç¾åœ¨ã®æŒ¯å¹…è¨­å®š)
    const amplitudes = [];
    for (let k = 1; k <= 10; k++) {
        // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼IDã«åŸºã¥ã„ã¦ç¾åœ¨ã®æŒ¯å¹…å€¤ã‚’å–å¾—
        const slider = document.getElementById(`slider-${k}`);
        // ã‚²ã‚¤ãƒ³ãƒãƒ¼ãƒ‰è¨­å®šæ™‚ã¨åŒã˜ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’é©ç”¨ (ä¾‹: * 0.2)
        const A_k = slider ? parseFloat(slider.value) * 0.2 : 0; 
        amplitudes.push(A_k);
    }
    
    // ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒ«ãƒ¼ãƒ—
    for (let n = 0; n < NUM_SAMPLES; n++) {
        const t = n / DRAW_SAMPLE_RATE; // ç¾åœ¨ã®æ™‚åˆ»
        let S_t = 0; // åˆæˆæ³¢å½¢ã®å€¤
        
        // 10å€‹ã®ã‚µã‚¤ãƒ³æ³¢ã‚’åˆæˆ
        for (let k = 1; k <= 10; k++) {
            // A_k * sin(2 * pi * k * f0 * t)
            S_t += amplitudes[k - 1] * Math.sin(2 * Math.PI * k * DRAW_FREQUENCY * t);
        }
        
        data.push(S_t);
    }
    
    return data;
}

const canvas = document.getElementById('waveformCanvas');
const ctx = canvas.getContext('2d');
const width = canvas.width;
const height = canvas.height;
const center_y = height / 2;
const scale = height / 2.2; // æç”»ã‚¹ã‚±ãƒ¼ãƒ«ï¼ˆæ³¢å½¢ãŒä¸Šä¸‹ã«ã¯ã¿å‡ºã•ãªã„ã‚ˆã†ã«èª¿æ•´ï¼‰

/**
 * ç”Ÿæˆã•ã‚ŒãŸæ³¢å½¢ãƒ‡ãƒ¼ã‚¿ã‚’Canvasã«æç”»ã™ã‚‹
 * @param {number[]} data - æ³¢å½¢ãƒ‡ãƒ¼ã‚¿é…åˆ—
 */
function drawWaveform(data) {
    // æç”»ã‚¯ãƒªã‚¢
    ctx.clearRect(0, 0, width, height);
    
    // åŸºæº–ç·šï¼ˆ0ãƒ©ã‚¤ãƒ³ï¼‰ã‚’æç”»
    ctx.strokeStyle = '#999';
    ctx.beginPath();
    ctx.moveTo(0, center_y);
    ctx.lineTo(width, center_y);
    ctx.stroke();

    // æ³¢å½¢ã®æç”»
    ctx.strokeStyle = '#007BFF'; // é’è‰²
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    const numPoints = data.length;
    
    for (let i = 0; i < numPoints; i++) {
        // xåº§æ¨™ï¼šã‚µãƒ³ãƒ—ãƒ«ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’Canvaså¹…ã«ãƒãƒƒãƒ”ãƒ³ã‚°
        const x = (i / numPoints) * width;
        
        // yåº§æ¨™ï¼šã‚µãƒ³ãƒ—ãƒ«å€¤ã‚’ä¸Šä¸‹åè»¢ã•ã›ã¦ä¸­å¿ƒç·šã‹ã‚‰ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°
        const y = center_y - (data[i] * scale);
        
        if (i === 0) {
            ctx.moveTo(x, y);
        } else {
            ctx.lineTo(x, y);
        }
    }
    
    ctx.stroke();
}

// ... (å‰è¿°ã® createSynth, togglePlay, generateWaveformData, drawWaveform é–¢æ•°ãŒã‚ã‚‹ã¨ã—ã¦) ...

function setupControls() {
    const controlsDiv = document.getElementById('controls');
    for (let k = 1; k <= 10; k++) {
        // ... (label, sliderã®ç”Ÿæˆã¯çœç•¥) ...
        
        slider.oninput = (e) => {
            // 1. éŸ³å£°ã®ã‚²ã‚¤ãƒ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¤‰æ›´ã™ã‚‹å‡¦ç† (å‰è¿°ã®ã‚‚ã®)
            if (gains[k - 1]) {
                gains[k - 1].gain.setValueAtTime(e.target.value * 0.2, audioContext.currentTime);
            }
            
            // 2. ğŸŒŸğŸŒŸğŸŒŸ æ³¢å½¢ã‚’æç”»æ›´æ–°ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ  ğŸŒŸğŸŒŸğŸŒŸ
            const waveformData = generateWaveformData();
            drawWaveform(waveformData);
        };

        // ... (controlsDivã¸ã®è¿½åŠ ã¯çœç•¥) ...
    }
    
    // åˆæœŸã®æ³¢å½¢ã‚’æç”»
    drawWaveform(generateWaveformData());
}

// document.addEventListener('DOMContentLoaded', setupControls); // ã“ã‚Œã‚’å®Ÿè¡Œ

